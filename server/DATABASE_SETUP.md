# MongoDB Database Setup for NexGenCRM

> **Note**: For complete backend setup instructions, see [BACKEND_SETUP.md](./BACKEND_SETUP.md). This guide focuses on MongoDB configuration.

## Quick Reference

### Connection String
```
mongodb://localhost:27017/nexgencrm
```

### Database Name
```
nexgencrm
```

### Collection
```
users
```

---

## MongoDB Installation

### Windows
1. Download from [mongodb.com/try/download/community](https://www.mongodb.com/try/download/community)
2. Run installer
3. Choose "Install as Windows Service"
4. Default port: `27017`

### Mac
```bash
brew install mongodb-community
brew services start mongodb-community
```

### Linux
```bash
sudo apt-get install mongodb
sudo systemctl start mongodb
```

---

## Verify MongoDB Installation

```bash
mongosh --eval "db.adminCommand('ping')"
```

**Expected output**: `{ ok: 1 }`

---

## Database Files

### Connection: `config/db.js`
```javascript
import mongoose from "mongoose";

const connectDB = async () => {
  try {
    await mongoose.connect("mongodb://localhost:27017/nexgencrm");
    console.log("✓ MongoDB connected successfully!");
  } catch (error) {
    console.error("MongoDB connection error:", error.message);
    process.exit(1);
  }
};

export default connectDB;
```

### Schema: `config/schema.js`
```javascript
import mongoose from "mongoose";

const userSchema = new mongoose.Schema({
  name: { type: String, required: true, trim: true },
  email: { type: String, required: true, unique: true, lowercase: true },
  mobile: { type: String, required: true },
  role: { type: String, enum: ["Sales", "Marketing", "Operations", "Manager", "Admin"], default: "Sales" },
  department: { type: String, trim: true },
  designation: { type: String, trim: true },
  dateOfBirth: { type: Date },
  gender: { type: String, enum: ["Male", "Female", "Other", ""], default: "" },
  address: { type: String, trim: true },
  city: { type: String, trim: true },
  state: { type: String, trim: true },
  country: { type: String, trim: true },
  status: { type: String, enum: ["Active", "Inactive"], default: "Active" },
  profilePhoto: { type: String, default: "" },
}, { timestamps: true });

const User = mongoose.model("User", userSchema);
export default User;
```

### Seeder: `seeders/seedUsers.js`
```javascript
import User from "../config/schema.js";

const seedUsers = async () => {
  try {
    await User.deleteMany({});
    
    const users = [
      { name: "John Doe", email: "john@example.com", mobile: "+1 555-8883322", ... },
      { name: "Jane Smith", email: "jane@example.com", mobile: "+1 555-123-7788", ... },
      // ... more users
    ];

    const createdUsers = await User.insertMany(users);
    console.log(`✓ Inserted ${createdUsers.length} sample users`);
    return createdUsers;
  } catch (error) {
    console.error("Error seeding database:", error);
  }
};

export default seedUsers;
```

---

## User Collection Structure

```javascript
{
  _id: ObjectId("65f3c8d9e4b0a1b2c3d4e5f6"),  // Auto-generated by MongoDB
  name: "John Doe",
  email: "john@example.com",                    // Unique constraint
  mobile: "+1 555-888-3322",
  role: "Admin",                                // Enum: Sales, Marketing, Operations, Manager, Admin
  department: "Operations",
  designation: "Operations Manager",
  dateOfBirth: ISODate("1990-05-15T00:00:00Z"),
  gender: "Male",
  address: "123 Main St",
  city: "New York",
  state: "NY",
  country: "USA",
  status: "Active",                             // Enum: Active, Inactive
  profilePhoto: "",
  createdAt: ISODate("2024-03-17T10:30:00Z"),   // Auto-generated
  updatedAt: ISODate("2024-03-17T10:30:00Z"),   // Auto-updated
  __v: 0
}
```

---

## MongoDB Shell Commands

### Connect to MongoDB
```bash
mongosh
```

### List Databases
```bash
show databases
```

### Switch to Database
```bash
use nexgencrm
```

### List Collections
```bash
show collections
```

### View All Users
```bash
db.users.find()
```

### View Formatted Users
```bash
db.users.find().pretty()
```

### Count Users
```bash
db.users.countDocuments()
```

### Find Single User
```bash
db.users.findOne({ email: "john@example.com" })
```

### Find by ObjectId
```bash
db.users.findOne({ _id: ObjectId("65f3c8d9e4b0a1b2c3d4e5f6") })
```

### Insert User (manual)
```bash
db.users.insertOne({
  name: "Alice Johnson",
  email: "alice@example.com",
  mobile: "+1 555-777-2222",
  role: "Sales",
  status: "Active"
})
```

### Update User
```bash
db.users.updateOne(
  { email: "john@example.com" },
  { $set: { status: "Inactive" } }
)
```

### Delete User
```bash
db.users.deleteOne({ email: "john@example.com" })
```

### Clear All Users
```bash
db.users.deleteMany({})
```

### Exit MongoDB
```bash
exit
```

---

## Mongoose Query Methods

| Operation | Method | Example |
|-----------|--------|---------|
| **Read All** | `.find()` | `User.find()` → Returns Array |
| **Read One** | `.findById()` | `User.findById(id)` → Returns Doc or null |
| **Read Query** | `.findOne()` | `User.findOne({ email })` → Returns Doc or null |
| **Create** | `.create()` | `User.create(data)` → Returns Doc |
| **Create** | `.save()` | `new User(data).save()` → Returns Doc |
| **Update** | `.findByIdAndUpdate()` | `User.findByIdAndUpdate(id, data, { new: true })` |
| **Delete** | `.findByIdAndDelete()` | `User.findByIdAndDelete(id)` |
| **Delete Multiple** | `.deleteMany()` | `User.deleteMany({})` |

---

## Common MongoDB Errors

### Cannot connect to MongoDB
**Error**: `MongooseError: Cannot connect to mongodb://localhost:27017/nexgencrm`

**Solution**: 
- Ensure MongoDB service is running
- Check connection string is correct
- Default port is 27017

### Duplicate key error (E11000)
**Error**: `MongoError: E11000 duplicate key error collection: nexgencrm.users index: email_1 dup key: { : "test@example.com" }`

**Solution**: 
- Email must be unique
- Check database for existing email
- Use different email or update existing record

### Invalid ObjectId (CastError)
**Error**: `CastError: Cast to ObjectId failed for value "123"`

**Solution**: 
- MongoDB ObjectId must be 24-character hex string
- Example valid ID: `65f3c8d9e4b0a1b2c3d4e5f6`
- Copy _id from query results

### Connection timeout
**Error**: `MongooseError: connect ECONNREFUSED 127.0.0.1:27017`

**Solution**: 
- Start MongoDB: `brew services start mongodb-community`
- Check MongoDB is running: `mongosh --eval "db.adminCommand('ping')"`
- Verify port 27017 is not blocked

---

## MongoDB Compass (GUI Tool)

### Installation
Download from [mongodb.com/products/compass](https://www.mongodb.com/products/compass)

### Usage
1. Open MongoDB Compass
2. Click "New Connection"
3. Enter: `mongodb://localhost:27017`
4. Click "Connect"
5. Navigate: `nexgencrm` → `users`
6. View and edit documents in GUI

---

## Data Types in Mongoose

| Type | Description | Example |
|------|-------------|---------|
| `String` | Text | `"John Doe"` |
| `Number` | Integer/Float | `1234567890` |
| `Date` | ISO Date | `ISODate("2024-03-17")` |
| `Boolean` | True/False | `true` |
| `ObjectId` | MongoDB ID | `ObjectId("...")` |
| `Array` | List of items | `["item1", "item2"]` |
| `Object` | Nested object | `{ field1: value1 }` |

---

## Schema Validation Rules

### In `config/schema.js`:

```javascript
const userSchema = new mongoose.Schema({
  email: {
    type: String,
    required: true,      // Field is mandatory
    unique: true,        // No duplicate values
    lowercase: true,     // Convert to lowercase
    trim: true,          // Remove whitespace
    match: /^[^\s@]+@[^\s@]+\.[^\s@]+$/  // Email regex
  },
  role: {
    type: String,
    enum: ["Admin", "Sales"],  // Only these values allowed
    default: "Sales"           // Default value
  },
  status: {
    type: String,
    enum: ["Active", "Inactive"],
    default: "Active"
  }
});
```

---

## API Routes Using MongoDB

### GET /api/users
```javascript
router.get("/", async (req, res) => {
  const users = await User.find();  // Get all docs
  res.json(users);
});
```

### GET /api/users/:id
```javascript
router.get("/:id", async (req, res) => {
  const user = await User.findById(req.params.id);  // Get by ObjectId
  if (!user) return res.status(404).json({ message: "Not found" });
  res.json(user);
});
```

### POST /api/users
```javascript
router.post("/", async (req, res) => {
  const newUser = await User.create(req.body);  // Create new doc
  res.status(201).json(newUser);
});
```

### PUT /api/users/:id
```javascript
router.put("/:id", async (req, res) => {
  const updated = await User.findByIdAndUpdate(
    req.params.id,
    req.body,
    { new: true }  // Return updated doc
  );
  res.json(updated);
});
```

### DELETE /api/users/:id
```javascript
router.delete("/:id", async (req, res) => {
  const deleted = await User.findByIdAndDelete(req.params.id);
  res.json({ message: "Deleted", user: deleted });
});
```

---

## Next Steps

1. **Start MongoDB**: Ensure MongoDB service is running
2. **Run Server**: `cd server && node index.js`
3. **Test API**: Use Postman to test endpoints
4. **Check Data**: Open MongoDB Compass to view collections

For complete setup instructions including frontend integration, see [BACKEND_SETUP.md](./BACKEND_SETUP.md).

---

**Version**: 2.0 (MongoDB)  
**Last Updated**: February 6, 2026  
**Database**: MongoDB with Mongoose ODM
